var Camera=cc.Node.extend({isPlatformLocked:null,updateYPos:false,hold:false,delta:null,update:function(e,t){if(this.hold==false){var i=cc.Director.getInstance().getWinSize();var s=t.position.x;var n;if(this.isPlatformLockCamera&&this.position!=null){n=this.position.y}else{n=t.position.y}var c=Math.max(s,i.width/2);var r=Math.max(n,i.height/2);c=Math.min(c,e.getMapSize().width*e.getTileSize().width-i.width/2);r=Math.min(r,e.getMapSize().height*e.getTileSize().height-i.height/2);var a=cc.p(c,r);var o=cc.p(i.width/2,i.height/2);var h=cc.pSub(o,a);if(this.isPlatformLockCamera){if(this.updateYPos==true){var p=cc.p(0,e.getPosition().y);var l=cc.p(0,h.y);var d=cc.pSub(l,p);var g=cc.MoveBy.create(.4,d);g.setTag(7);e.runAction(g);e.setPosition(cc.p(h.x,e.getPosition().y));this.updateYPos=false}else{e.setPosition(cc.p(h.x,e.getPosition().y));if(e.getActionByTag(7)!=null){e.getActionByTag(7)._endPosition.x=h.x}}}else{e.setPosition(h)}}},updatePosition:function(e){if(cc.pDistance(this.getPosition(),e)>64){this.setPosition(e);this.updateYPos=true}},updateHard:function(e,t){var i=cc.Director.getInstance().getWinSize();var s=t.x;var n=t.y;var c=Math.max(s,i.width/2);var r=Math.max(n,i.height/2);c=Math.min(c,e.getMapSize().width*e.getTileSize().width-i.width/2);r=Math.min(r,e.getMapSize().height*e.getTileSize().height-i.height/2);var a=cc.p(c,r);var o=cc.p(i.width/2,i.height/2);var h=cc.pSub(o,a);e.setPosition(h)}});var Door=cc.Node.extend({key:null,isOpen:false,sprite:null,tileMapObject:null,collisionBox:null,init:function(e){this.position=cc.p(e.x,e.y);if(e.type.match("open")!=null){this.isOpen=true}this.key=e.type.replace("open","").replace("door","").trim();this.collisionBox=cc.RectMake(e.x,e.y,e.width,e.height);this.sprite=new cc.Sprite;this.sprite.initWithFile("/res/door.png");this.sprite.getTexture().setAliasTexParameters();this.sprite.setScaleX(e.width/this.sprite.getTexture().getContentSizeInPixels().width);this.sprite.setScaleY(e.height/this.sprite.getTexture().getContentSizeInPixels().height);this.tileMapObject=e},update:function(e){if(this.isOpen&&this.sprite.numberOfRunningActions()==0){this.sprite.setOpacity(0)}this.sprite.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2))},open:function(e){var t=new cc.FadeOut;t.initWithDuration(.4);this.sprite.runAction(t);this.isOpen=true;e.getObjects().splice(e.getObjects().indexOf(this.tileMapObject),1)}});var Eater=cc.Node.extend({sprite:null,velocity:null,desiredPosition:null,walkAnimation:null,isLeft:false,eatAnimation:null,collisionRect:null,lastPathFindingCollidedWith:null,isEating:false,isDead:false,isCleanUp:false,forewardStepX:null,init:function(){this.walkAnimation=new cc.Animation;this.walkAnimation.initWithSpriteFrames([cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_walk 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_walk 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_walk 3.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_walk 4.png")],.1);this.eatAnimation=new cc.Animation;this.eatAnimation.initWithSpriteFrames([cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_eat 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_eat 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_eat 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_eat 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_eat 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_eat 2.png")],.1);this.sprite=new cc.Sprite;this.sprite.initWithSpriteFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_walk 1.png"));this.sprite.setScaleX(5);this.sprite.setScaleY(5);this.sprite.getTexture().setAliasTexParameters();this.velocity=cc.p(0,0);this.forewardStepX=1090;this.isDead=false},kill:function(){if(!this.isDead){this.isDead=true;var e=cc.FadeOut.create(.5);var t=cc.ParticleSystemQuad.create("/res/player_die_particle.plist");t.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2));t.setAutoRemoveOnFinish(true);this.sprite.stopAllActions();this.sprite.getParent().addChild(t,7);this.sprite.runAction(e)}},update:function(e){if(this.isDead&&this.sprite.numberOfRunningActions()==0){this.isCleanUp=true}if(!this.isEating&&!this.isDead){this.sprite.setPosition(cc.p(this.position.x+this.sprite.getTextureRect().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2));if(this.collisionRect==null){this.collisionRect=cc.RectMake(0,0,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height)}var t=cc.p(0,-640);var i=cc.pMult(t,e);var s=cc.p(this.forewardStepX,0);var n=cc.pMult(s,e);this.velocity=cc.pAdd(this.velocity,i);this.velocity=cc.p(this.velocity.x*.89,this.velocity.y);if(this.isLeft){this.velocity=cc.pSub(this.velocity,n)}else{this.velocity=cc.pAdd(this.velocity,n)}var c=cc.p(-850,-450);var r=cc.p(850,350);this.velocity=cc.pClamp(this.velocity,c,r);var a=cc.pMult(this.velocity,e);this.desiredPosition=cc.pAdd(this.position,a);this.collisionRect.origin=this.desiredPosition;this.sprite.setFlipX(this.isLeft);this.sprite.setFlipY(false);if(this.isOnGround&&Math.abs(this.velocity.x)>10&&this.sprite.numberOfRunningActions()==0){var o=new cc.Animate;o.setTag(1);o.initWithAnimation(this.walkAnimation);var h=cc.RepeatForever.create(o);this.sprite.runAction(h)}if(this.isOnGround&&Math.abs(this.velocity.x)<10){this.sprite.stopAllActions();this.sprite.setDisplayFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("eater_walk 1.png"))}}},testCollision:function(e){this.isOnGround=false;var t=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);for(var i=0;i<e.getObjects().length;i++){var s=e.getObjects()[i];var n=cc.RectMake(s.x,s.y,s.width,s.height);if(cc.Rect.CCRectIntersectsRect(n,t)){var c=false;if(s.type=="LAVA"){this.kill()}if(s.type=="WATER"){c=true;this.forewardStepX=500}var r=cc.Rect.CCRectIntersection(n,t);if(!c){if(r.size.width<r.size.height){if(r.origin.x>this.desiredPosition.x){this.desiredPosition=cc.p(this.desiredPosition.x-r.size.width,this.desiredPosition.y);this.velocity=cc.p(0,this.velocity.y);this.isLeft=!this.isLeft}else{this.desiredPosition=cc.p(this.desiredPosition.x+r.size.width,this.desiredPosition.y);this.velocity=cc.p(0,this.velocity.y);this.isLeft=!this.isLeft}}else if(r.size.width>r.size.height){if(r.origin.y>this.desiredPosition.y){this.desiredPosition=cc.p(this.desiredPosition.x,this.desiredPosition.y-r.size.height);this.velocity=cc.p(this.velocity.x,0)}else if(r.origin.y==this.desiredPosition.y){this.desiredPosition=cc.p(this.desiredPosition.x,this.desiredPosition.y+r.size.height);this.velocity=cc.p(this.velocity.x,0);this.isOnGround=true}}}}}this.position=cc.p(this.desiredPosition.x,this.desiredPosition.y)},testPathFinding:function(e){var t=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);for(var i=0;i<e.getObjects().length;i++){var s=e.getObjects()[i];var n=cc.RectMake(s.x,s.y,s.width,s.height);if(cc.Rect.CCRectIntersectsRect(n,t)&&this.lastPathFindingCollidedWith!=s){this.isLeft=!this.isLeft;this.lastPathFindingCollidedWith=s}}},resumeWalking:function(){this.isEating=false},testPlayer:function(e){var t=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);if(cc.Rect.CCRectIntersectsRect(e.collisionRect,t)&&!this.isEating){this.isEating=true;var i=new cc.Animate;i.initWithAnimation(this.eatAnimation);var s=new cc.Sequence;s.initOneTwo(i,cc.CallFunc.create(this.resumeWalking,this,null));this.sprite.stopAllActions();this.sprite.runAction(s);cc.AudioEngine.getInstance().playEffect("/res/chomp.wav",false);return true}return false}});var Egg=cc.Node.extend({sprite:null,winAnimation:null,collisionBox:null,direction:null,init:function(){this.winAnimation=new cc.Animation;this.winAnimation.initWithSpriteFrames([cc.SpriteFrameCache.getInstance().getSpriteFrame("egg_goal 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("egg_goal 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("egg_goal 3.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("egg_goal 4.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("egg_goal 6.png")],.1);this.sprite=new cc.Sprite;this.sprite.initWithSpriteFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("egg_goal.png"));this.sprite.setScaleX(5);this.sprite.setScaleY(5);this.sprite.getTexture().setAliasTexParameters()},update:function(e){if(this.direction=="DOWN"){this.sprite.setFlipY(true);this.sprite.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2-this.collisionBox.size.height+10))}else if(this.direction=="UP"){this.sprite.setFlipY(false);this.sprite.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2-10))}},runWinAnimation:function(){var e=new cc.Animate;e.initWithAnimation(this.winAnimation);this.sprite.runAction(e)}});var IntroLayer=cc.Layer.extend({init:function(){var e=new cc.Sprite;e.initWithFile("/res/title.png");e.setPosition(cc.p(cc.Director.getInstance().getWinSize().width/2,cc.Director.getInstance().getWinSize().height/2+50));e.setScaleX(2);e.setScaleY(2);var t=new cc.Sprite;t.initWithFile("/res/title_2.png");t.setPosition(cc.p(cc.Director.getInstance().getWinSize().width/2,cc.Director.getInstance().getWinSize().height/2-100));t.setScaleX(2);t.setScaleY(2);this.addChild(e,12);this.addChild(t,12);this.setPosition(cc.p(0,0));this.setKeyboardEnabled(true);this.scheduleUpdate()},onKeyDown:function(e){Keys[e]=true},onKeyUp:function(e){Keys[e]=false},update:function(e){if(Keys[cc.KEY.enter]){this.changeScene()}},changeScene:function(){this.unschedule(this.changeScene);cc.Director.getInstance().pushScene(new HelloWorldScene)}});var IntroScene=cc.Scene.extend({onEnter:function(){this._super();var e=new IntroLayer;e.init();this.addChild(e);cc.AudioEngine.getInstance().playMusic("/res/intro.mp3",true)}});var Key=cc.Node.extend({key:null,isCollected:false,sprite:null,collisionBox:null,init:function(e){this.position=cc.p(e.x,e.y);this.collisionBox=cc.RectMake(e.x,e.y,e.width,e.height);this.sprite=new cc.Sprite;this.sprite.initWithFile("/res/key.png");this.sprite.setScaleX(5);this.sprite.setScaleY(5);this.sprite.getTexture().setAliasTexParameters();this.sprite.setOpacity(255);this.sprite.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2));var t=new cc.MoveBy;t.initWithDuration(1,cc.p(0,10));var i=new cc.MoveBy;i.initWithDuration(1,cc.p(0,-10));var s=new cc.Sequence;s.initOneTwo(t,i);var n=new cc.RepeatForever;n.initWithAction(s);this.sprite.runAction(n);this.key=e.type.replace("key","").trim()},update:function(e){if(this.isCollected){this.sprite.setOpacity(0)}},collect:function(){this.isCollected=true;this.sprite.setOpacity(0)}});var Keys={},levelIndex=1,isDebug=false;var keyColors=[new cc.Color3B(0,255,8),new cc.Color3B(0,115,255),new cc.Color3B(255,115,255),new cc.Color3B(255,255,0),new cc.Color3B(255,0,0),new cc.Color3B(255,0,149),new cc.Color3B(100,230,45),new cc.Color3B(100,230,45),new cc.Color3B(100,230,45),new cc.Color3B(100,230,45)];var Helloworld=cc.Layer.extend({player:null,tileMap:null,camera:null,timeStep:1/60,delta:0,secondCounter:10,font:null,spores:[],eaters:[],keys:[],doors:[],isResetting:false,egg:null,colourLayer:null,isPaused:false,pauseFont:null,pauseButtonTick:0,init:function(e){this._super();this.camera=new Camera;this.camera.hold=false;this.camera.isPlatformLockCamera=false;this.setKeyboardEnabled(true);cc.SpriteFrameCache.getInstance().addSpriteFrames("/res/player_spritesheet.plist");var t=cc.SpriteBatchNode.create("/res/player_spritesheet.png",1);this.addChild(t);cc.SpriteFrameCache.getInstance().addSpriteFrames("/res/spore.plist");var i=cc.SpriteBatchNode.create("/res/spore.png",1);this.addChild(i);cc.SpriteFrameCache.getInstance().addSpriteFrames("/res/egg_goal_spritesheet.plist");var s=cc.SpriteBatchNode.create("/res/egg_goal_spritesheet.png",1);this.addChild(s);cc.SpriteFrameCache.getInstance().addSpriteFrames("/res/eater.plist");var n=cc.SpriteBatchNode.create("/res/eater.png",1);this.addChild(n);this.tileMap=cc.TMXTiledMap.create(e);this.font=cc.LabelTTF.create("10","Press Start 2P",32);this.font.position=cc.p(0,0);var c=new cc.Layer;this.pauseFont=cc.LabelTTF.create("Paused","Press Start 2P",50);this.pauseFont.setVisible(false);c.addChild(this.font);c.addChild(this.pauseFont);c.setPosition(cc.p(cc.Director.getInstance().getWinSize().width/2,cc.Director.getInstance().getWinSize().height-50));this.addChild(c,10);this.colourLayer=new cc.LayerColor;this.colourLayer.init(new cc.Color3B(255,0,0),cc.Director.getInstance().getWinSize().width,cc.Director.getInstance().getWinSize().height);this.colourLayer.setPosition(0,0);this.colourLayer.setOpacity(0);this.addChild(this.colourLayer,12);var r=cc.SAXParser.getInstance().tmxParse(e);var a=cc.ParallaxNode.create();var o=new cc.Sprite;o.initWithFile("/res/ludum_dare_background.png");o.setPosition(cc.p(400,500));o.setScaleX(8);o.setScaleY(8);o.getTexture().setAliasTexParameters();a.addChild(o,1,cc.p(.02,.02),cc.p(512,256));this.addChild(a,0);this.player=new PlatformPlayer;this.player.init();this.player.id=Math.random();this.player.desiredPosition=cc.p(cc.Director.getInstance().width/2,cc.Director.getInstance().height/2);this.player.position=cc.p(cc.Director.getInstance().width/2,cc.Director.getInstance().height/2);this.tileMap.addChild(this.player.sprite,5);var h=this.tileMap.getLayer("transparent");if(h!=null){this.tileMap.reorderChild(this.tileMap.getLayer("transparent"),12)}this.tileMap.position=cc.p(cc.Director.getInstance().width/2,cc.Director.getInstance().height/2);this.addChild(this.tileMap);var p=this.tileMap.getObjectGroup("Static");this.keys=[];this.doors=[];if(p.length==0){console.log("statics are empty")}for(var l=0;l<p.getObjects().length;l++){var d=p.getObjects()[l];if(d.type=="player_start"){this.player.position=cc.p(d.x,d.y);this.tileMap.stopActionByTag(7);this.tileMap.position=cc.p(cc.Director.getInstance().width/2,cc.Director.getInstance().height/2);this.camera.updateHard(this.tileMap,cc.p(d.x,d.y));this.player.lastSpawnBeacon=cc.p(d.x,d.y)}if(d.type=="goal_up"||d.type=="goal_down"){this.egg=new Egg;this.egg.position=cc.p(d.x,d.y);this.egg.init();this.tileMap.addChild(this.egg.sprite,4);this.egg.collisionBox=cc.RectMake(d.x,d.y,d.width,d.height);if(d.type=="goal_down"){this.egg.direction="DOWN"}else{this.egg.direction="UP"}}if(d.type.match("key_object")!=null){var g=new Key;g.init(d);this.tileMap.addChild(g.sprite,12);this.keys.push(g)}}this.spores=[];p=this.tileMap.getObjectGroup("Beacon");if(p.length==0){console.log("beacons are empty")}for(var u=0;u<p.getObjects().length;u++){var y=p.getObjects()[u];var f=new Spore;f.initialize();f.collisionBox=cc.RectMake(y.x,y.y,y.width,y.height);f.position=cc.p(y.x,y.y);f.direction=y.type.replace("high","").replace("FIRE","").replace("WATER","").replace("FLOAT","").trim();f.sporeType=y.type.replace("high","").replace("UP","").replace("DOWN","").trim();if(y.type.match("high")!=null){f.isHighJump=true}this.tileMap.addChild(f.sprite,4);this.spores.push(f)}p=this.tileMap.getObjectGroup("Collision");if(p.length==0){console.log("collisions are empty")}for(var m=0;m<p.getObjects().length;m++){var v=p.getObjects()[m];if(v.type.match("door_object")!=null){var w=new Door;w.init(v);this.tileMap.addChild(w.sprite);for(var S=0;S<this.keys.length;S++){var P=this.keys[S];if(P.key==w.key){P.sprite.setColor(keyColors[S]);w.sprite.setColor(keyColors[S])}}this.doors.push(w)}}this.eaters=[];p=this.tileMap.getObjectGroup("Enemies");if(p.length==0){console.log("enemies are empty")}for(var F=0;F<p.getObjects().length;F++){var x=p.getObjects()[F];var C=new Eater;C.init();C.position=cc.p(x.x,x.y);this.tileMap.addChild(C.sprite);this.eaters.push(C)}p=this.tileMap.getObjectGroup("Particles");if(p.length==0){console.log("particles are empty")}if(p){for(var A=0;A<p.getObjects().length;A++){var I=p.getObjects()[A];var B=new cc.ParticleSystemQuad;B.initWithFile("/res/"+I.type);B.setPosition(cc.p(I.x+I.width/2,I.y+I.height/2));B.setPositionType(cc.PARTICLE_TYPE_RELATIVE);this.tileMap.addChild(B,10)}}this.scheduleUpdate();if(this.egg==null){console.log("egg is null")}this.schedule(function(){if(!this.player.isDead&&this.secondCounter>=0&&!this.isPaused){if(this.secondCounter<=0){this.blowUp()}this.secondCounter--;if(this.secondCounter<=2&&this.secondCounter>=0&&this.colourLayer.numberOfRunningActions()==0){var e=new cc.Sequence;var t=new cc.FadeTo;t.initWithDuration(.1,100);var i=new cc.FadeTo;i.initWithDuration(.1,0);e.initOneTwo(t,i);this.colourLayer.runAction(e)}this.font.setString(this.secondCounter)}},1,null,!isDebug?10:0);return true},moveCameraToLastBeacon:function(){var e=this.player.lastSpawnBeacon.collisionBox;var t=cc.p(e.origin.x+e.size.width/2,e.origin.y+e.size.height/2);this.camera.updateHard(this.tileMap,t)},respawnPlayer:function(){this.player.sprite.setOpacity(255);this.player.position=cc.p(this.player.lastSpawnBeacon.position.x+this.player.lastSpawnBeacon.getBoundingBox().size.width/2,this.player.lastSpawnBeacon.position.y+this.player.lastSpawnBeacon.getBoundingBox().size.height/2);if(this.player.lastSpawnBeacon.isHighJump){this.camera.isPlatformLockCamera=false;this.player.spawnJumpHigh()}else{this.player.spawnJump()}if(this.player.nextDirection!=null){this.player.direction=this.player.nextDirection}if(this.player.lastSpawnBeacon.sporeType==SporeTypeEnum.FIRE){this.player.powerUp=firePowerUp}else if(this.player.lastSpawnBeacon.sporeType==SporeTypeEnum.WATER){this.player.powerUp=waterPowerUp}else if(this.player.lastSpawnBeacon.sporeType==SporeTypeEnum.FLOAT){this.player.powerUp=floatyPowerUp}else{this.player.powerUp=noPowerUp}this.player.sprite.setColor(this.player.powerUp.playerColour());this.player.isDead=false;this.isResetting=false;this.player.shouldBlowUp=false},animateSpawnBeacon:function(){this.player.lastSpawnBeacon.sprite.stopAllActions();var e=cc.Animate.create(this.player.lastSpawnBeacon.spawnAnimation);this.player.lastSpawnBeacon.sprite.runAction(e)},blowUp:function(){if(this.player.lastSpawnBeacon!=null&&this.player.lastSpawnBeacon instanceof Spore){this.player.kill();var e=cc.ParticleSystemQuad.create("/res/player_die_particle.plist");e.setPosition(cc.p(this.player.position.x+this.player.sprite.getBoundingBox().size.width/2,this.player.position.y+this.player.sprite.getBoundingBox().size.height/2));e.setAutoRemoveOnFinish(true);this.tileMap.addChild(e,7);var t=cc.DelayTime.create(1);var i=cc.CallFunc.create(this.moveCameraToLastBeacon,this,null);var s=cc.DelayTime.create(.1);var n=cc.CallFunc.create(this.animateSpawnBeacon,this,null);var c=cc.DelayTime.create(.4);var r=cc.CallFunc.create(this.respawnPlayer,this,null);var a=cc.Sequence.create([t,i,s,n,c,r]);this.runAction(a);this.secondCounter=11}},setViewPointCenter:function(){this.camera.update(this.tileMap,this.player)},update:function(e){this.delta+=e;if(this.delta>=this.timeStep&&!this.isPaused){this.player.update(e,this.camera);this.egg.update(e);this.player.testCollision(this.tileMap.getObjectGroup("Collision"),this.camera);this.player.testBeacon(this.spores,this.camera);this.player.testDoors(this.doors,this.tileMap.getObjectGroup("Collision"),this.keys);this.player.testKeys(this.keys);if(this.player.testGoal(this.egg)){this.player.isDead=true;this.unscheduleAllCallbacks();this.gotoNextLevel()}for(var t=0;t<this.spores.length;t++){this.spores[t].update(e)}for(var i=this.eaters.length-1;i>=0;i--){this.eaters[i].update(e);if(!this.eaters[i].isDead){this.eaters[i].testCollision(this.tileMap.getObjectGroup("Collision"));this.eaters[i].testPathFinding(this.tileMap.getObjectGroup("PathFinding"))}if(!this.isResetting){if(this.eaters[i].testPlayer(this.player)){if(!this.eaters[i].isDead){this.isResetting=true;this.blowUp()}}}if(this.eaters[i].isCleanUp){this.tileMap.removeChild(this.eaters[i].sprite);this.eaters.splice(i,1)}}for(var s=0;s<this.doors.length;s++){this.doors[s].update(e)}for(var n=0;n<this.keys.length;n++){this.keys[n].update(e)}if(this.player.shouldBlowUp&&!this.isResetting){this.isResetting=true;this.blowUp()}this.setViewPointCenter();if(Keys[cc.KEY.y]&&!this.isResetting){this.isResetting=true;this.blowUp()}}if(Keys[cc.KEY.escape]&&this.pauseButtonTick<=0){this.isPaused=!this.isPaused;this.pauseButtonTick=.3}if(this.isPaused){this.pauseFont.setVisible(true)}else{this.pauseFont.setVisible(false)}this.pauseButtonTick-=e},gotoNextLevel:function(){levelIndex++;cc.Director.getInstance().replaceScene(cc.TransitionFade.create(12,new HelloWorldScene,new cc.Color3B(0,0,0)))},onKeyDown:function(e){Keys[e]=true},onKeyUp:function(e){Keys[e]=false}});var HelloWorldScene=cc.Scene.extend({onEnter:function(){this._super();var e;if(e==null){e="/res/level"+levelIndex+".tmx"}var t;if(levelIndex>9){var i=new EndScene;cc.Director.getInstance().pushScene(i);return}else{t=new Helloworld;t.init(e)}if(levelIndex==1){cc.AudioEngine.getInstance().playMusic("/res/intro.mp3",true)}else if(levelIndex==3||levelIndex==4){cc.AudioEngine.getInstance().playMusic("/res/ludum_dare_innocent_mysterious.mp3",true)}else if(levelIndex<=7&&levelIndex>3){cc.AudioEngine.getInstance().playMusic("/res/ludum_dare_quiet.mp3",true)}else if(levelIndex>7){cc.AudioEngine.getInstance().playMusic("/res/ludum_dare_intense.mp3",true)}this.addChild(t)}});var AnimationEnum={IDLE:0,RUN:1,JUMP:2};var DirectionEnum={UP:"UP",DOWN:"DOWN"};var PlatformPlayer=cc.Node.extend({id:null,sprite:null,speed:250,jumpTimer:null,velocity:null,desiredPosition:null,collisionRect:null,isOnGround:null,isLeft:false,idleAnimation:null,lastSpawnBeacon:null,displayedFrame:null,direction:DirectionEnum.UP,nextDirection:null,isDead:false,shouldBlowUp:null,powerUp:null,spawnBurst:0,init:function(){this.sprite=new cc.Sprite;this.sprite.initWithSpriteFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 1.png"));this.sprite.getTexture().setAliasTexParameters();this.idleAnimation=new cc.Animation;this.idleAnimation.initWithSpriteFrames([cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 3.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 4.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 3.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 2.png")],.08);this.sprite.position=this.position;this.velocity=cc.p(0,0);this.powerUp=noPowerUp;this.sprite.setColor(noPowerUp.playerColour());return this},kill:function(){this.isDead=true;var e=cc.FadeOut.create(.5);this.sprite.runAction(e);cc.AudioEngine.getInstance().playEffect("/res/hurt.wav",false)},spawnJump:function(){var e;this.velocity=cc.p(0,0);if(this.direction==DirectionEnum.UP){e=cc.p(0,9500);this.velocity=cc.pAdd(this.velocity,e)}else if(this.direction==DirectionEnum.DOWN){e=cc.p(0,-9500);this.velocity=cc.pAdd(this.velocity,e)}},spawnJumpHigh:function(){var e;this.velocity=cc.p(0,0);if(this.direction==DirectionEnum.UP){e=cc.p(0,25500);this.velocity=cc.pAdd(this.velocity,e)}else if(this.direction==DirectionEnum.DOWN){e=cc.p(0,-25500);this.velocity=cc.pAdd(this.velocity,e)}this.spawnBurst=12e3},velocityUp:function(e){var t=cc.p(0,-640);var i=cc.pMult(t,e);var s=cc.p(680,0);var n=cc.pMult(s,e);this.velocity=cc.pAdd(this.velocity,i);this.velocity=cc.p(this.velocity.x*.89,this.velocity.y);if(this.isOnGround&&Keys[cc.KEY.space]){var c=cc.p(0,8700);this.velocity=cc.pAdd(this.velocity,c);cc.AudioEngine.getInstance().playEffect("/res/jump.wav",false)}if(Keys[cc.KEY.a]||Keys[cc.KEY.left]){this.velocity=cc.pSub(this.velocity,n);this.isLeft=false}if(Keys[cc.KEY.d]||Keys[cc.KEY.right]){this.velocity=cc.pAdd(this.velocity,n);this.isLeft=true}var r=cc.p(-850,-450);var a=cc.p(850,350+this.spawnBurst);this.velocity=cc.pClamp(this.velocity,r,a);this.spawnBurst=0},velocityDown:function(e){var t=cc.p(0,640);var i=cc.pMult(t,e);var s=cc.p(680,0);var n=cc.pMult(s,e);this.velocity=cc.pAdd(this.velocity,i);this.velocity=cc.p(this.velocity.x*.89,this.velocity.y);if(this.isOnGround&&Keys[cc.KEY.space]){var c=cc.p(0,-8700);this.velocity=cc.pAdd(this.velocity,c);cc.AudioEngine.getInstance().playEffect("/res/jump.wav",false)}if(Keys[cc.KEY.a]||Keys[cc.KEY.left]){this.velocity=cc.pSub(this.velocity,n);this.isLeft=false}if(Keys[cc.KEY.t]){this.position=cc.p(cc.Director.getInstance().width/2,cc.Director.getInstance().height/2)}if(Keys[cc.KEY.d]||Keys[cc.KEY.right]){this.velocity=cc.pAdd(this.velocity,n);this.isLeft=true}var r=cc.p(-850,450);var a=cc.p(850,-450-this.spawnBurst);this.velocity=cc.pClamp(this.velocity,r,a);this.spawnBurst=0},update:function(e,t){if(!this.isDead){this.sprite.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2));if(this.collisionRect==null){this.collisionRect=cc.RectMake(0,0,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height)}if(this.direction==DirectionEnum.UP){this.velocityUp(e);this.renderSpritesUp(t)}else if(this.direction==DirectionEnum.DOWN){this.velocityDown(e);this.renderSpritesDown(t)}var i=cc.pMult(this.velocity,e);this.desiredPosition=cc.pAdd(this.position,i);this.collisionRect.origin=this.desiredPosition}},doOnCollisionUp:function(e,t,i,s){if(s.size.width<s.size.height){if(s.origin.x>this.desiredPosition.x){this.desiredPosition=cc.p(this.desiredPosition.x-s.size.width,this.desiredPosition.y);this.velocity=cc.p(0,this.velocity.y)}else{this.desiredPosition=cc.p(this.desiredPosition.x+s.size.width,this.desiredPosition.y);this.velocity=cc.p(0,this.velocity.y)}}else if(s.size.width>s.size.height){if(s.origin.y>this.desiredPosition.y){this.desiredPosition=cc.p(this.desiredPosition.x,this.desiredPosition.y-s.size.height);this.velocity=cc.p(this.velocity.x,0)}else if(s.origin.y==this.desiredPosition.y){this.desiredPosition=cc.p(this.desiredPosition.x,this.desiredPosition.y+s.size.height);if(i!=null){i.updatePosition(cc.p(this.desiredPosition.x,this.desiredPosition.y))}this.velocity=cc.p(this.velocity.x,0);this.isOnGround=true;i.isPlatformLockCamera=true}}},doOnCollisionDown:function(e,t,i,s){if(s.size.width<s.size.height){if(s.origin.x>this.desiredPosition.x){this.desiredPosition=cc.p(this.desiredPosition.x-s.size.width,this.desiredPosition.y);this.velocity=cc.p(0,this.velocity.y)}else{this.desiredPosition=cc.p(this.desiredPosition.x+s.size.width,this.desiredPosition.y);this.velocity=cc.p(0,this.velocity.y)}}else if(s.size.width>s.size.height){if(s.origin.y>this.desiredPosition.y){this.desiredPosition=cc.p(this.desiredPosition.x,this.desiredPosition.y-s.size.height);this.velocity=cc.p(this.velocity.x,0);if(i!=null){i.updatePosition(cc.p(this.desiredPosition.x,this.desiredPosition.y))}this.isOnGround=true;i.isPlatformLockCamera=true}else if(s.origin.y==this.desiredPosition.y){this.desiredPosition=cc.p(this.desiredPosition.x,this.desiredPosition.y+s.size.height);this.velocity=cc.p(this.velocity.x,0)}}},renderSpritesUp:function(e){this.sprite.setFlipX(!this.isLeft);this.sprite.setFlipY(false);if(this.velocity.y<-400){if(e){e.isPlatformLockCamera=false}}if(this.velocity.y<-100){this.sprite.stopAllActions();this.sprite.setDisplayFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("player_jumping.png"));this.displayedFrame=AnimationEnum.JUMP}if(this.velocity.y>10&&this.displayedFrame!=AnimationEnum.JUMP){this.sprite.stopAllActions();this.sprite.setDisplayFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("player_jumping.png"));this.displayedFrame=AnimationEnum.JUMP}if(this.isOnGround&&Math.abs(this.velocity.x)>10&&this.sprite.numberOfRunningActions()==0&&this.displayedFrame!=AnimationEnum.RUN){var t=new cc.Animate;t.setTag(1);t.initWithAnimation(this.idleAnimation);var i=cc.RepeatForever.create(t);this.sprite.runAction(i);this.displayedFrame=AnimationEnum.RUN}if(this.isOnGround&&Math.abs(this.velocity.x)<10&&this.displayedFrame!=AnimationEnum.IDLE){this.sprite.stopAllActions();this.sprite.setDisplayFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 1.png"));this.displayedFrame=AnimationEnum.IDLE}},renderSpritesDown:function(e){this.sprite.setFlipX(!this.isLeft);this.sprite.setFlipY(true);if(this.velocity.y>400){if(e){e.isPlatformLockCamera=false}}if(this.velocity.y>100){this.sprite.stopAllActions();this.sprite.setDisplayFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("player_jumping.png"));this.displayedFrame=AnimationEnum.JUMP}if(this.velocity.y<-10&&this.displayedFrame!=AnimationEnum.JUMP){this.sprite.stopAllActions();this.sprite.setDisplayFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("player_jumping.png"));this.displayedFrame=AnimationEnum.JUMP}if(this.isOnGround&&Math.abs(this.velocity.x)>10&&this.sprite.numberOfRunningActions()==0&&this.displayedFrame!=AnimationEnum.RUN){var t=new cc.Animate;t.setTag(1);t.initWithAnimation(this.idleAnimation);var i=cc.RepeatForever.create(t);this.sprite.runAction(i);this.displayedFrame=AnimationEnum.RUN}if(this.isOnGround&&Math.abs(this.velocity.x)<10&&this.displayedFrame!=AnimationEnum.IDLE){this.sprite.stopAllActions();this.sprite.setDisplayFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("player_walking 1.png"));this.displayedFrame=AnimationEnum.IDLE}},testCollision:function(e,t){this.isOnGround=false;var i=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);for(var s=0;s<e.getObjects().length;s++){var n=e.getObjects()[s];var c=cc.RectMake(n.x,n.y,n.width,n.height);if(cc.Rect.CCRectIntersectsRect(c,i)){var r=cc.Rect.CCRectIntersection(c,i);var a=false;if(n.type=="LAVA"&&!this.powerUp.isFireProof()){this.shouldBlowUp=true}else if(n.type=="WATER"&&!this.powerUp.isWaterProof()){this.shouldBlowUp=true}else if(n.type=="WATER"&&this.powerUp.isWaterProof()){a=true}if(!a){if(this.direction==DirectionEnum.UP){this.doOnCollisionUp(c,n,t,r)}else if(this.direction==DirectionEnum.DOWN){this.doOnCollisionDown(c,n,t,r)}}}}this.position=cc.p(this.desiredPosition.x,this.desiredPosition.y)},testBeacon:function(e){var t=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);for(var i=0;i<e.length;i++){var s=e[i];var n=s.collisionBox;if(cc.Rect.CCRectIntersectsRect(n,t)){this.lastSpawnBeacon=s;this.nextDirection=s.direction;if(!s.isActive){for(var c=0;c<e.length;c++){var r=e[c];r.deActivate()}s.activate()}}}},testDoors:function(e,t,i){var s=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);for(var n=0;n<e.length;n++){var c=e[n];var r=c.collisionBox;if(cc.Rect.CCRectIntersectsRect(r,s)){if(!c.isOpen){for(var a=0;a<i.length;a++){var o=i[a];if(o.isCollected&&o.key==c.key){c.open(t)}}}}}},testKeys:function(e){var t=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);for(var i=0;i<e.length;i++){var s=e[i];var n=s.collisionBox;if(cc.Rect.CCRectIntersectsRect(n,t)){if(!s.isCollected){s.collect()}}}},testGoal:function(e){var t=cc.RectMake(this.desiredPosition.x,this.desiredPosition.y,this.sprite.getTextureRect().size.width,this.sprite.getTextureRect().size.height);var i=e.collisionBox;if(cc.Rect.CCRectIntersectsRect(i,t)){this.sprite.setVisible(false);e.runWinAnimation();return true}return false}});
var noPowerUp={isFireProof:function(){return false},isWaterProof:function(){return false},canFloat:function(){return false},antiGravityAmount:function(){return cc.p(0,0)},playerColour:function(){return new cc.Color3B(46,153,102)}};var firePowerUp={isFireProof:function(){return true},isWaterProof:function(){return false},canFloat:function(){return false},antiGravityAmount:function(){return cc.p(0,0)},playerColour:function(){return new cc.Color3B(201,44,52)}};var waterPowerUp={isFireProof:function(){return false},isWaterProof:function(){return true},canFloat:function(){return false},antiGravityAmount:function(){return cc.p(0,30)},playerColour:function(){return new cc.Color3B(53,102,203)}};var floatyPowerUp={isFireProof:function(){return false},isWaterProof:function(){return false},canFloat:function(){return true},antiGravityAmount:function(){},playerColour:function(){return new cc.Color3B(50,50,30)}};var SporeTypeEnum={FIRE:"FIRE",WATER:"WATER",FLOAT:"FLOAT"};var Spore=cc.Node.extend({sprite:null,isActive:false,idleAnimation:null,spawnAnimation:null,activateAnimation:null,collisionBox:null,direction:null,sporeType:null,isHighJump:false,initialize:function(){this.idleAnimation=new cc.Animation;this.idleAnimation.initWithSpriteFrames([cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_idle 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_idle 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_idle 3.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_idle 4.png")],.1);this.spawnAnimation=new cc.Animation;this.spawnAnimation.initWithSpriteFrames([cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_spawning 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_spawning 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_spawning 3.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_spawning 4.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_spawning 5.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_spawning 6.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_spawning 7.png")],.1);this.activateAnimation=new cc.Animation;this.activateAnimation.initWithSpriteFrames([cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_activating 1.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_activating 2.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_activating 3.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_activating 4.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_activating 5.png"),cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_activating 6.png")],.1);this.sprite=new cc.Sprite;this.sprite.initWithSpriteFrame(cc.SpriteFrameCache.getInstance().getSpriteFrame("spore_activating 1.png"));this.sprite.setScaleX(5);this.sprite.setScaleY(5);this.sprite.getTexture().setAliasTexParameters()},update:function(e){if(this.direction=="DOWN"){this.sprite.setFlipY(true);this.sprite.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2-this.collisionBox.size.height))}else if(this.direction=="UP"){this.sprite.setFlipY(false);this.sprite.setPosition(cc.p(this.position.x+this.sprite.getBoundingBox().size.width/2,this.position.y+this.sprite.getBoundingBox().size.height/2))}if(this.sporeType=="FIRE"){this.sprite.setColor(new cc.Color3B(200,0,0))}else if(this.sporeType=="WATER"){this.sprite.setColor(new cc.Color3B(0,0,200))}},activate:function(){if(!this.isActive){this.sprite.stopAllActions();var e=new cc.Animate;e.initWithAnimation(this.activateAnimation);this.sprite.runAction(e);this.isActive=true}},deActivate:function(){if(this.isActive){this.sprite.stopAllActions();var e=new cc.Animate;e.initWithAnimation(this.activateAnimation);this.sprite.runAction(e.reverse());this.isActive=false}}});var EndScene=cc.Scene.extend({onEnter:function(){this._super();var e=new EndLayer;e.init();this.addChild(e);cc.AudioEngine.getInstance().playMusic("/res/intro.mp3",true)}});var EndLayer=cc.Layer.extend({init:function(){var e=new cc.Sprite;e.initWithFile("/res/win.png");e.setPosition(cc.p(cc.Director.getInstance().getWinSize().width/2,cc.Director.getInstance().getWinSize().height/2));e.getTexture().setAliasTexParameters();this.addChild(e,12);this.setPosition(cc.p(0,0));this.setKeyboardEnabled(true);this.schedule(this.changeScene,1,0,10)},onKeyDown:function(e){Keys[e]=true},onKeyUp:function(e){Keys[e]=false},update:function(e){if(Keys[cc.KEY.enter]){this.changeScene()}},changeScene:function(){this.unschedule(this.changeScene);cc.Director.getInstance().pushScene(new IntroScene)}});